/*!
 * @cloudbase/weda-cloud-sdk
 * CopyrightÂ© 2021 Tencent
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("mobx"),require("@cloudbase/js-sdk")):"function"==typeof define&&define.amd?define(["exports","mobx","@cloudbase/js-sdk"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CloudSDK={},e.mobx,e.cloudbase)}(this,(function(e,t,n){"use strict";function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=r(n);function s(e,t){return!!e&&Object.prototype.hasOwnProperty.call(e,t)}var o,u={},i={};function c(e){if(!o)throw new Error("app config not inited");return e?o[e]:o}function f(e){o=Object.assign(o||{},e)}function l(e){return function(e,t){return"lcap-"+e.id+"-"+e.name+(t?"-preview":"")}(e,!(o&&o.isProd))}function d(e,t){return e.length===t.length&&e.every((function(e,n){return e===t[n]}))}var h=[];function p(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=h.find((function(n){return n[0]===e&&d(n[1],t)}));if(r)return r[2];var a=e.apply(void 0,t);return h.push([e,t,a]),a}function v(e,t){return e?t.reduce((function(t,n){return s(e,n)&&(t[n]=e[n]),t}),{}):e}function m(e,t,n,r){return new(n||(n=Promise))((function(a,s){function o(e){try{i(r.next(e))}catch(e){s(e)}}function u(e){try{i(r.throw(e))}catch(e){s(e)}}function i(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,u)}i((r=r.apply(e,t||[])).next())}))}function b(e,t){var n,r,a,s,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function u(s){return function(u){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&s[0]?r.return:s[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,s[1])).done)return a;switch(r=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){o.label=s[1];break}if(6===s[0]&&o.label<a[1]){o.label=a[1],a=s;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(s);break}a[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}}function g(e){return m(this,void 0,void 0,(function(){var t,n,r,a,s,o;return b(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,,3]),(t=c("beforeDSRequest"))&&t(e),!(n=u[e.dataSourceName]))throw new Error("datasource "+e.dataSourceName+" not found");if(!(r=n[e.methodName]))throw new Error("method "+e.methodName+" not found in datasource "+e.dataSourceName+" ");return[4,r(e.params)];case 1:return a=i.sent(),(o=c("afterDSRequest"))&&o(e,null,a),[2,a];case 2:throw s=i.sent(),(o=c("afterDSRequest"))&&o(e,s),s;case 3:return[2]}}))}))}function y(e){return m(this,void 0,void 0,(function(){return b(this,(function(t){switch(t.label){case 0:return[4,c("initTcb")()];case 1:return[4,t.sent().app.callFunction(e)];case 2:return[2,t.sent()]}}))}))}var w=Object.freeze({__proto__:null,callDataSource:g,callFunction:y,getCloudInstance:function(){return m(this,void 0,void 0,(function(){return b(this,(function(e){switch(e.label){case 0:return[4,c("initTcb")()];case 1:return[2,e.sent().app]}}))}))}});function S(e,t){var n=e.split(".");if(2===n.length){var r=i[n[0]],a=n[1];if(r&&(s(r.state.$status,a)||s(r.state,a))){if(r.state.$status[a]){if(t instanceof Error)return void(r.state.$status[a]={status:"failed",code:-1,message:t.message,error:t});"success"!==r.state.$status[a].status&&(r.state.$status[a]={status:"success"})}r.state[a]=t}}else console.warn("[ds]setStateVar: invalid varPath",e)}var j={};function O(e,t){var n=j[e];return n&&"function"==typeof n?n(t):n}function P(e){var t=[];if("database"===e.type){var n=e.config.defaultMethods||e.config.methods||[];t.push.apply(t,n)}e.methods&&t.push.apply(t,e.methods.map((function(e){return e.name})));var r,a={$setDefaultParams:(r=e.name,function(e){j[r]=e})};return t.reduce((function(t,n){return t[n]=function(e,t){return function(n){return m(this,void 0,void 0,(function(){var r,a,s;return b(this,(function(o){switch(o.label){case 0:r=l(e||{}),o.label=1;case 1:return o.trys.push([1,3,,4]),a={params:n,methodName:t},[4,y({name:r,data:{methodName:t,defaultParams:O(e.name,a),params:n}})];case 2:return[2,o.sent().result];case 3:return s=o.sent(),console.warn("[weda-cloud-sdk] failed to invoke datasource "+r+"'s method "+t,s),[2,{code:s.errCode||-2,message:s.errMsg||s.message}];case 4:return[2]}}))}))}}(e,n),t}),a)}function D(e,t){if(e){var n=Object.keys(e);return n.length?n.reduce((function(n,r){if(n[r]="",t){var a=e[r];n[r]=a.sampleValue||""}return n}),{}):{}}}function T(e){return e?Object.keys(e).reduce((function(t,n){var r=e[n];return"state"!==r.varType||(t[n]=r.initialValue),t}),{}):{}}var k=Object.assign({$call:g},u),x=Object.assign({dataSources:u},w),N={setState:S,setParams:function(e,t){var n=(c("datasetProfiles")||{})[e],r=i[e];r&&n&&n.params&&(r.params=v(t,Object.keys(n.params)))}};function $(e){var t=e.dataSourceProfiles;if(f(e),t){var n=c("customCreateDataSources");if(n)return n(t),void Object.assign(k,u);t.reduce((function(e,t){return e[t.name]=P(t),e}),u),Object.assign(k,u)}}function _(){return m(this,void 0,void 0,(function(){var e,t,n;return b(this,(function(r){switch(r.label){case 0:return e=c(),t=a.default.init({env:e.envID}),(n=t.auth({persistence:"local"})).hasLoginState()?[3,2]:[4,n.anonymousAuthProvider().signIn()];case 1:r.sent(),r.label=2;case 2:return[2,{app:t}]}}))}))}function C(){return m(this,void 0,void 0,(function(){return b(this,(function(e){return[2,p(_)]}))}))}$({initTcb:C}),e.CLOUD_SDK=x,e.DATASET_CONTEXT=i,e.DS_API=u,e.DS_SDK=k,e.EXTRA_API=N,e._setConfig=f,e.callDataSource=g,e.createDataset=function(e,n){var r=(c("datasetProfiles")||{})[e],a=t.observable({state:{$status:{}},params:{}});if(i[e]=a,!r)return a;var s=D(r.params,n),o=T(r.state);return Object.assign(a.params,s),Object.assign(a.state,o),a},e.createParamsVar=D,e.createStateDataSourceVar=function(e,t){var n,r;return m(this,void 0,void 0,(function(){var a,s,o,u=this;return b(this,(function(f){return a=null===(n=i[e])||void 0===n?void 0:n.state,s=c("datasetProfiles")||{},o=null===(r=s[e])||void 0===r?void 0:r.state,a&&o?(Object.keys(o).forEach((function(n){return m(u,void 0,void 0,(function(){var r,s,u,i;return b(this,(function(c){switch(c.label){case 0:if("datasource"!==(r=o[n]).varType)return[2];if(!r.initMethod||!r.initMethod.name)return a[n]={},a.$status[n]={status:"idle"},[2];c.label=1;case 1:return c.trys.push([1,3,,4]),a.$status[r.name]={status:"loading"},s=r.initMethod,[4,g({dataSourceName:r.dataSourceName,methodName:s.name,params:t(s.params,s),options:{showLoading:!0}})];case 2:return(u=c.sent()).code?a.$status[r.name]={status:"failed",code:u.code,message:u.message,error:u}:S(e+"."+r.name,u.data),[3,4];case 3:return i=c.sent(),console.error(i),S(e+"."+r.name,i),[3,4];case 4:return[2]}}))}))})),[2]):[2]}))}))},e.createStaticStateVar=T,e.execOnce=p,e.generateParamsParser=function(e){return function(t){if(!t)return t;var n={};for(var r in t)n[r]=t[r](e.app,e.$page);return n}},e.getCloudFnName=l,e.getConfig=c,e.initTcb=C,e.isSameArray=d,e.pick=v,e.setConfig=$,Object.defineProperty(e,"__esModule",{value:!0})}));
