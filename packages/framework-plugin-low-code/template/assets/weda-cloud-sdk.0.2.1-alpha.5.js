/*!
 * @cloudbase/weda-cloud-sdk
 * CopyrightÂ© 2021 Tencent
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("mobx"),require("@cloudbase/js-sdk")):"function"==typeof define&&define.amd?define(["exports","mobx","@cloudbase/js-sdk"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CloudSDK={},e.mobx,e.cloudbase)}(this,(function(e,t,n){"use strict";function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=r(n),o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};function s(e,t,n,r){return new(n||(n=Promise))((function(a,o){function s(e){try{i(r.next(e))}catch(e){o(e)}}function u(e){try{i(r.throw(e))}catch(e){o(e)}}function i(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}i((r=r.apply(e,t||[])).next())}))}function u(e,t){var n,r,a,o,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(o){return function(u){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;switch(r=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(a=s.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){s.label=o[1];break}if(6===o[0]&&s.label<a[1]){s.label=a[1],a=o;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(o);break}a[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}}var i=function(e){function t(t,n){var r=e.call(this,n)||this;return r.code=t,r.name="TCBError",r}return function(e,t){function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}(t,e),t}(Error);function c(e,t){return!!e&&Object.prototype.hasOwnProperty.call(e,t)}var f,l="lcap-common-service",d={},p={};function h(e){if(!f)throw new Error("app config not inited");return e?f[e]:f}function m(e){f=Object.assign(f||{},e)}function v(e){return function(e,t){return"lcap-"+e.id+"-"+e.name+(t?"-preview":"")}(e,!(null==f?void 0:f.isProd))}function b(e,t){return e.length===t.length&&e.every((function(e,n){return e===t[n]}))}var g=[];function y(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=g.find((function(n){return n[0]===e&&b(n[1],t)}));if(r)return r[2];var a=e.apply(void 0,t);return g.push([e,t,a]),a}function w(e,t){if(!e)return e;return t.reduce((function(t,n){return c(e,n)&&(t[n]=e[n]),t}),{})}var S={};function O(e,t){S[e]=t}function D(e,t){var n=S[e];return n&&"function"==typeof n?n(t):n}function P(e){return function(t){O(e,t)}}var j={};function k(e){return s(this,void 0,void 0,(function(){var t,n,r,a,o,s;return u(this,(function(u){switch(u.label){case 0:if(u.trys.push([0,2,,3]),(t=h("beforeDSRequest"))&&t(e),!(n=d[e.dataSourceName]))throw new Error("datasource "+e.dataSourceName+" not found");if(!(r=n[e.methodName]))throw new Error("method "+e.methodName+" not found in datasource "+e.dataSourceName+" ");return[4,r(e.params)];case 1:return a=u.sent(),(s=h("afterDSRequest"))&&s(e,null,a),[2,a];case 2:throw o=u.sent(),(s=h("afterDSRequest"))&&s(e,o),o;case 3:return[2]}}))}))}function A(e,t){return s(this,void 0,void 0,(function(){var n,r,a,o,s;return u(this,(function(u){switch(u.label){case 0:return n=h("initTcb"),r=h("isProd"),a={envType:r?"prod":"pre",wedaTarget:j.wedaTarget},e.data=Object.assign({},e.data,a),[4,n()];case 1:return[4,u.sent().app.callFunction(e)];case 2:if(o=u.sent(),null==t?void 0:t.unwrapResult){if(s=o.result,!t.parseBusinessInfo)return[2,s];if(!s.code)return[2,s.data];throw new i(s.code,s.message)}return[2,o]}}))}))}function N(e){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,A({name:l,data:e},{unwrapResult:!0,parseBusinessInfo:!0})]}))}))}function I(e){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,N({methodName:"callWedaApi",params:e}).then((function(e){return e.Data}))]}))}))}var T={get dataSources(){return m({parseBusinessInfo:!0}),d},get callDataSource(){return m({parseBusinessInfo:!0}),k}},_={wrapperDatasourceMethod:function(e){return function(t){return T.callDataSource({dataSourceName:e.dataSourceName,methodName:e.methodName,params:t})}}},E=Object.assign(T,{version:"0.2.1-alpha.5",utils:_,getCloudInstance:function(){return s(this,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return[4,h("initTcb")()];case 1:return[2,e.sent().app]}}))}))},callFunction:A,callWorkflow:function(e){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,I(e)]}))}))},callWedaApi:I,setConfig:function(e){Object.assign(j,e)},checkAuth:function(e){return I({action:"DescribeWedaAccessResourcesByType",data:e})},setDataSourceDefaultParams:O});function C(e){var t=[];"database"===e.type&&Array.isArray(e.schema["x-defaultMethods"])&&t.push.apply(t,e.schema["x-defaultMethods"]),e.methods&&t.push.apply(t,e.methods.map((function(e){return e.name})));var n={$setDefaultParams:P(e.name)};return t.reduce((function(t,n){return t[n]=function(e,t){return function(n){return s(this,void 0,void 0,(function(){var r,a,o,s;return u(this,(function(u){switch(u.label){case 0:(r=h("parseBusinessInfo"))&&m({parseBusinessInfo:!1}),a=v(e||{}),u.label=1;case 1:return u.trys.push([1,3,,4]),o={params:n,methodName:t},[4,A({name:a,data:{methodName:t,defaultParams:D(e.name,o),params:n}},{unwrapResult:!0,parseBusinessInfo:r})];case 2:return[2,u.sent()];case 3:if(s=u.sent(),console.warn("[weda-cloud-sdk] failed to invoke datasource "+a+"'s method "+t,s),r)throw s;return[2,{code:s.errCode||-2,message:s.errMsg||s.message}];case 4:return[2]}}))}))}}(e,n),t}),n)}var x={get $call(){return m({parseBusinessInfo:!1}),k}};function $(){Object.keys(d).forEach((function(e){Object.defineProperty(x,e,{get:function(){return m({parseBusinessInfo:!1}),d[e]},configurable:!0,enumerable:!0})}))}function M(e,t){var n=e.split(".");if(2===n.length){var r=p[n[0]],a=n[1];if(r&&(c(r.state.$status,a)||c(r.state,a))){if(r.state.$status[a]){if(t instanceof Error)return void(r.state.$status[a]={status:"failed",code:t.code||-1,message:t.message,error:t});"success"!==r.state.$status[a].status&&(r.state.$status[a]={status:"success"})}r.state[a]=t}}else console.warn("[weda-cloud-sdk]setStateVar: invalid varPath",e)}$();var B={setState:M,setParams:function(e,t){var n=(h("datasetProfiles")||{})[e],r=p[e];r&&n&&n.params&&(r.params=w(t,Object.keys(n.params)))}};function R(e,t){if(e){var n=Object.keys(e);if(!n.length)return{};return n.reduce((function(n,r){if(n[r]="",t){var a=e[r];n[r]=a.sampleValue||""}return n}),{})}}function U(e){if(!e)return{};return Object.keys(e).reduce((function(t,n){var r=e[n];return"state"!==r.varType||(t[n]=r.initialValue),t}),{})}function V(e){var t=e.dataSourceProfiles;if(m(e),t){var n=h("customCreateDataSources");if(n)return n(t),void Object.assign(x,d);t.reduce((function(e,t){return e[t.name]=C(t),e}),d),$()}}function L(){return s(this,void 0,void 0,(function(){var e,t,n,r,o,s;return u(this,(function(u){switch(u.label){case 0:return e=h(),t=window._WedaHostConfig,n=(null==t?void 0:t.tcbInstance)?t.tcbInstance:a.default.init({env:e.envID}),r=n.auth({persistence:"local"}),o=r.hasLoginState(),(null==t?void 0:t.login)?(o&&"ANONYMOUS"!==o.loginType||t.login(),[3,6]):[3,1];case 1:return o?[3,6]:[4,r.anonymousAuthProvider().signIn()];case 2:if(u.sent(),!e.afterAnonymousLogin)return[3,6];u.label=3;case 3:return u.trys.push([3,5,,6]),[4,e.afterAnonymousLogin({isAnonymous:!0})];case 4:return u.sent(),[3,6];case 5:return s=u.sent(),console.warn("[weda-cloud-sdk] failed to sign into weda backend",s),[3,6];case 6:return[2,{app:n,auth:r}]}}))}))}function q(){return s(this,void 0,void 0,(function(){return u(this,(function(e){return[2,y(L)]}))}))}var W,K=null;function F(e){return s(this,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return W===e.isAnonymous&&K?[2,K]:[4,N({methodName:"signIn",params:e||{}})];case 1:return K=t.sent(),W=e.isAnonymous,[2,K]}}))}))}m({afterAnonymousLogin:F});var X={signIn:F,getUserInfo:function(){return s(this,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return K?[3,2]:[4,N({methodName:"getUserInfo",params:{}})];case 1:K=e.sent(),e.label=2;case 2:return[2,K]}}))}))},signOut:function(e){return s(this,void 0,void 0,(function(){var t,n,r;return u(this,(function(a){switch(a.label){case 0:if(void 0===W)return[2];if((!e||!e.force)&&W)throw new Error("[weda-cloud-sdk]unable to sign out anonymous user");return K=null,t=W,[4,h("initTcb")()];case 1:return(n=a.sent().auth).signOut(),W=void 0,t?[2]:[4,n.anonymousAuthProvider().signIn()];case 2:a.sent(),a.label=3;case 3:return a.trys.push([3,5,,6]),[4,F({isAnonymous:!0})];case 4:return a.sent(),[3,6];case 5:return r=a.sent(),console.warn("[weda-cloud-sdk] failed to sign into weda backend after normal sign out",r),[3,6];case 6:return[2]}}))}))},get currentUser(){return K?Object.assign({},K):null}};Object.assign(E,X),Object.defineProperty(E,"currentUser",{get:function(){return X.currentUser}}),V({initTcb:q}),e.CLOUD_SDK=E,e.COMMON_SERVICE_NAME=l,e.DATASET_CONTEXT=p,e.DS_API=d,e.DS_SDK=x,e.EXTRA_API=B,e._setConfig=m,e.callDataSource=k,e.createDataset=function(e,n){var r=(h("datasetProfiles")||{})[e],a=t.observable({state:{$status:{}},params:{}});if(p[e]=a,!r)return a;var o=R(r.params,n),s=U(r.state);return Object.assign(a.params,o),Object.assign(a.state,s),a},e.createParamsVar=R,e.createSetDefaultParams=P,e.createStateDataSourceVar=function(e,t){var n,r;return s(this,void 0,void 0,(function(){var a,o,i,c=this;return u(this,(function(f){return a=null===(n=p[e])||void 0===n?void 0:n.state,o=h("datasetProfiles")||{},i=null===(r=o[e])||void 0===r?void 0:r.state,a&&i?(Object.keys(i).forEach((function(n){return s(c,void 0,void 0,(function(){var r,o,s,c;return u(this,(function(u){switch(u.label){case 0:if("datasource"!==(r=i[n]).varType)return[2];if(!r.initMethod||!r.initMethod.name)return a[n]={},a.$status[n]={status:"idle"},[2];u.label=1;case 1:return u.trys.push([1,3,,4]),a.$status[r.name]={status:"loading"},o=r.initMethod,[4,E.callDataSource({dataSourceName:r.dataSourceName,methodName:o.name,params:t(o.params,o),options:{showLoading:!0}})];case 2:return s=u.sent(),M(e+"."+r.name,s),[3,4];case 3:return c=u.sent(),console.error("[weda-cloud-sdk] failed to init "+e+"."+r.name,c),M(e+"."+r.name,c),[3,4];case 4:return[2]}}))}))})),[2]):[2]}))}))},e.createStaticStateVar=U,e.execOnce=y,e.generateParamsParser=function(e){return function(t){if(!t)return t;var n={};return Object.keys(t).forEach((function(r){n[r]=t[r](e.app,e.$page)})),n}},e.getCloudFnName=v,e.getConfig=h,e.getDefaultParams=D,e.initTcb=q,e.isSameArray=b,e.pick=w,e.setConfig=V,e.setDefaultParams=O,Object.defineProperty(e,"__esModule",{value:!0})}));
